
**Quark Manager — Руководство по workflow**

Этот документ описывает поведение и команды `./quark-manager.sh`: доступные команды, опции, переменные окружения и рекомендуемые сценарии использования. Документ предназначен для разработчиков и операторов, которые запускают стек Quark локально или в staging.

Расположение скрипта: `./quark-manager.sh`

Обзор
- Скрипт выполняет единый интерфейс управления: сборка образов, поднятие/остановка сервисов, проверка статуса и health, вспомогательные команды для UI и валидации структуры проекта.
- Основные обязанности:
  - Ordered build (инфраструктура → ядро → приложения → вторичные сервисы)
  - Ordered start (прогрев Verdaccio → инфра → ядро → приложения)
  - Ожидание health и агрегированный статус

Команды (кратко)
- `start` — поднять сервисы (по умолчанию ordered start для всех групп сервисов).
- `stop` — остановить сервисы (все или указанные).
- `restart` — перезапустить сервис(ы) (stop → start).
- `build` — ordered build (включая запуск Verdaccio для прогрева кэша).
- `rebuild` — пересборка с `--no-cache`, затем start.
- `status` — показать статус сервисов и health.
- `health` — выполнить health-проверки API-сервисов.
- `logs` — посмотреть логи (все или выбранные сервисы).
- `clean` — очистить контейнеры/образы/потренировать систему.
- `hard-reboot` — ОПАСНАЯ: полная очистка контейнеров, образов и томов после подтверждения.
- `menu` — простое интерактивное меню.
- `ui:dev` — запустить UI в режиме разработки (локально: `pnpm install && pnpm run dev` в `infra/quark-ui`).
- `ui:build` / `ui:start` — сборка и запуск UI через docker compose.
- `spec:*` — утилиты, связанные с генерацией/валидацией спецификаций.

Опции
- `-f, --force` — принудительное выполнение операций.
- `-q, --quiet` — тихий режим (меньше интерактивных сообщений).
- `-v, --verbose` — подробный лог.
- `--skip-outdated-check` — пропустить проверку версий пакетов.
- `--skip-env-check` — пропустить проверку наличия `.env`.
- `--require-env` — сделать файл `.env` обязательным.
- `--ensure-structure` — выполнить проверку структуры проекта перед операцией.
- `--skip-structure-check` — явно пропустить проверку структуры.

Переменные окружения и настройки по умолчанию
- `COMPOSE_FILE` — `./docker-compose.yml` (по умолчанию).
- `LOG_DIR` — `./logs`.
- `ENV_FILE` — `./.env`.
- `DOCKER_BUILDKIT=1` экспортируется для ускорения сборок.

Ключевое поведение
- Внутри скрипта используется helper `dc()` который всегда вызывает `docker compose -f "$COMPOSE_FILE" ...`, чтобы гарантировать единый файл compose.
- Ordered build выполняет шаги:
  1) Сборка и запуск `verdaccio` для прогрева кэша.
  2) (Опционально) Прогрев локального Verdaccio (делается небольшой `pnpm install` в временной папке).
  3) Сборка infra: `vault`, `postgres`, `redis`, `nats`.
  4) Сборка `plugin-hub`.
  5) Сборка основных приложений: `auth-service`, `blog-service`, `quark-ui`, `quark-landing`.
  6) Сборка secondary infra: monitoring, minio, swagger-ui, traefik.
- Ordered start поднимает группы сервисов последовательно и ждёт их readiness/health используя `wait_for_health`.
- `wait_for_health` имеет специальную обработку `verdaccio`: HTTP 200 на `127.0.0.1:4873` считается признаком здоровья.

Прогрев Verdaccio: зачем это нужно и как сделать опциональным
- Зачем: прогрев локального реестра ускоряет последующие сборки (пакеты будут загружаться из локального cache), особенно полезно на CI и при чистых окружениях.
- Проблема: прогрев добавляет значительное время к `start`/`build` (нужно делать только при свежей установке).
- Текущее поведение: скрипт запускает Verdaccio и выполняет небольшой `pnpm install` в каталоге `.cache/quark-cache` чтобы «подтянуть» некоторые пакеты.
- Как сделать опциональным (рекомендации):
  - Скрипт можно расширить флагом `--skip-cache-warmup` или переменной окружения `SKIP_VERDACCIO_WARMUP=true` — это самый чистый вариант.
  - Если нужно быстро: запускайте `./quark-manager.sh start -q -f` после того, как образы уже собраны — это уменьшит интерактивность, но не всегда отключает прогрев (зависит от реализации скрипта).
  - Для точного контроля используйте `docker compose up -d` вручную для сервисов, не требующих прогрева.

Тонкая настройка health/timeouts
- Для быстрого локального старта можно уменьшить `start_period`/`timeout` в `docker-compose.yml` у сервисов: postgres, vault, redis, nats и т.д. Однако в продакшене эти значения должны быть консервативными.

Примеры использования
- Полный цикл (с нуля):
```bash
./quark-manager.sh hard-reboot   # ОЧЕНЬ осторожно
./quark-manager.sh build        # ordered build, включает прогрев verdaccio
./quark-manager.sh start        # ordered start
./quark-manager.sh status       # краткий статус и health
```

- Быстрый старт (если образы уже собраны):
```bash
./quark-manager.sh start -q -f
# или поднять только нужные сервисы вручную через docker compose
docker compose up -d postgres redis vault nats plugin-hub quark-auth quark-blog-service quark-landing quark-ui
```

- Перезапуск одного сервиса:
```bash
./quark-manager.sh restart quark-ui
```

Отладка и проверки
- Если порт занят, `check_ports` попытается понять, занят ли это verdaccio (порт 4873) и либо продолжит, либо предложит освобождение.
- Просмотр логов для сервиса:
```bash
./quark-manager.sh logs quark-ui
```
- Проверка локальных образов:
```bash
docker images | grep quark
```

Рекомендации и лучшие практики
- Локальная разработка: один раз выполнить `./quark-manager.sh build`, дальше использовать `./quark-manager.sh start -q -f` для итераций.
- CI: собирать образы в CI pipeline и пушить в приватный registry; избегать интерактивных шагов.
- Синхронизировать `NPM_REGISTRY` между Dockerfile и скриптом (`http://verdaccio:4873` внутри docker сети).

Заметки для операторов
- `hard-reboot` удаляет тома и образы — не используйте на машинах с критичными данными без бэкапа.
- Автоматические попытки убить/освободить процесс на используемом порту могут повредить внешним сервисам — на shared-хостах действуйте аккуратно.

История изменений
- 2025-11-27: Создан первоначальный русскоязычный документ с описанием workflow и рекомендациями.

Где редактировать
- Скрипт: `./quark-manager.sh`
- Compose: `./docker-compose.yml`
- Dockerfile'ы: `infra/quark-ui/Dockerfile`, `services/auth-service/Dockerfile`, `services/blog-service/Dockerfile`

---
Если нужно, могу добавить пример PR description или предложить реализацию `--skip-cache-warmup` флага в `quark-manager.sh`.

Детальное поведение команд и опций
=================================
Ниже приведено подробное описание того, что именно делает каждая команда скрипта, какова её цель и какой ожидаемый результат. Это поможет при рефакторинге `quark-manager.sh` (в т.ч. при переносе логики в более структурированную утилиту).

1) `start`
- Последовательность действий:
  1. Вызывается `check_env_file` (предупреждение/файл `.env`).
  2. Вызывается `check_requirements`/`ensure_docker` — подтверждение наличия `docker` и `docker compose`.
  3. `check_ports` проверяет критичные порты (включая специальную обработку порта `4873` для Verdaccio).
  4. `check_project_structure` выполняется только если включён `--ensure-structure`.
  5. Если запускается без сервисов — вызывается `start_ordered`:
     - Поднимает `verdaccio` (`dc up -d verdaccio`) и ждёт его health (HTTP 200 на 127.0.0.1:4873).
     - При успешном прогреве выполняет локальный `pnpm install` в временной папке для прогрева кэша (если включено).
     - По группам поднимает infra primary (vault, postgres, redis, nats) — для каждого вызывает `dc up -d <service>` и `wait_for_health <service> <timeout>`.
     - Поднимает infra secondary, core services и затем приложения в заранее заданном порядке, ожидая health для каждого.
- Цель: гарантированно и воспроизводимо поднять стек в правильном порядке, чтобы зависимости были готовы до старта приложений.
- Ожидаемый результат: контейнеры запущены; критичные сервисы имеют `healthy` либо `running` статус (если у контейнера нет healthcheck). В логах видно успешное подключение к infra.
- Возможные ошибки и recovery: таймауты health → проверить логи (`./quark-manager.sh logs <service>`), увеличить `start_period`/`timeout` или отлаживать сервис вручную.

2) `stop`
- Последовательность действий:
  - Если сервисы не указаны — вызывается `dc down` (останавливает все сервисы, но не всегда удаляет тома).
  - Если указаны конкретные сервисы — проверяется их наличие `validate_service`, затем `dc stop <service>` по одному.
- Цель: корректно остановить указанные сервисы или весь стек.
- Ожидаемый результат: указанные контейнеры переходят в статус `exited`/`stopped`.
- Возможные ошибки: сервис не найден → `validate_service` вернёт ошибку и операция прервётся.

3) `restart`
- Последовательность действий: выполняет `stop` для указанных сервисов (или всех), ждёт 2 секунды, затем выполняет `start`.
- Цель: корректно перезапустить сервисы, гарантируя, что они стартуют в том же порядке и с теми же проверками health.
- Ожидаемый результат: сервисы перезапущены и проходят health или остаются в `running`.

4) `build`
- Последовательность действий:
  - Если не указаны сервисы, выполняется `ordered_build`:
    1. `dc build verdaccio`.
    2. `dc up -d verdaccio` и `wait_for_health verdaccio` — затем optional cache warmup (`pnpm install` в `.cache/quark-cache`).
    3. `dc build vault postgres redis nats` (infra primary).
    4. `dc build plugin-hub`.
    5. `dc build auth-service blog-service quark-ui quark-landing`.
    6. `dc build monitoring minio swagger-ui traefik`.
  - Если указаны сервисы, вызывает `dc build <services...>`.
- Цель: получить актуальные Docker-образы для всех сервисов в правильном порядке; прогрев Verdaccio — опциональная оптимизация.
- Ожидаемый результат: локальные образы с префиксом/именем quark- собраны и доступны в `docker images`.
- Возможные ошибки: ошибки сборки Dockerfile — посмотреть логи BuildKit, проверить network/args (например `NPM_REGISTRY`) и кеши buildkit.

5) `rebuild`
- Последовательность действий: вызывает `rebuild_services` (по сути `dc build --no-cache`), затем `start_services`.
- Цель: форсированная пересборка без использования кэшей.

6) `status`
- Последовательность действий: `show_status` собирает список контейнеров через `dc ps`, затем для каждого контейнера читает `docker inspect` (`.State.Status` и `.State.Health.Status`) и формирует краткий обзор и таблицу `dc ps`.
- Цель: дать быстрый обзор что запущено, что healthy, а что в состоянии ожидания/ошибки.
- Ожидаемый результат: человек-оператор видит краткий и подробный статус всех сервисов.

7) `health`
- Последовательность действий: `health_check` итерирует сервисы из `dc config --services` и проверяет их состояние в `dc ps`/JSON для базовой информации.
- Цель: быстрое API-level здоровье сервиса (интеграция с `wait_for_health` для старта).

8) `logs`
- Последовательность действий: вызывает `dc logs` либо `dc logs <services...>`; выводит сквозные логи compose.
- Цель: диагностика проблем при старте/выполнении.

9) `clean`
- Последовательность действий: `dc down --rmi all --volumes --remove-orphans` и `docker system prune -f`.
- Цель: очистить всё локально (контейнеры/образы/тома), вернуть систему в «чистое» состояние.

10) `hard-reboot`
- Последовательность действий: интерактивный запрос подтверждения; при `yes` — `docker compose down --rmi all --volumes --remove-orphans` и `docker system prune -af --volumes`.
- Цель: полная очистка всех артефактов (полезно при тестировании/CI или когда нужно убрать «грязь»).
- Риски: удаляются тома — потеря данных.

11) `menu`
- Последовательность действий: запускает `select`-меню в bash с набором опций (start, stop, rebuild, status и т.д.).
- Цель: удобная интерактивная работа без запоминания параметров.

12) `ui:dev`, `ui:build`, `ui:start`
- `ui:dev` — запускает `pnpm install && pnpm run dev` в каталоге `infra/quark-ui` (локально). Цель — удобный dev workflow.
- `ui:build` — вызывает `dc build quark-ui`.
- `ui:start` — `dc up -d quark-ui`.

13) `spec:new`, `spec:validate` и другие `spec:*`
- `spec:new <name>` — создаёт структуру новой спецификации в каталоге `specs/` и копирует шаблоны.
- `spec:validate` — запускает инструменты в docker (Spectral / asyncapi) для валидации OpenAPI/AsyncAPI файлов.

Опции и флаги (детально)
- `-f, --force` — при наличии используется в командах, где скрипт поддерживает принудительное выполнение (например rebuild/start в тихом режиме). Обычно подавляет интерактивные подтверждения.
- `-q, --quiet` — уменьшает количество выводимых сообщений, полезно для CI или быстрого старта.
- `-v, --verbose` — включает более подробное логирование.
- `--skip-outdated-check` — внутренняя оптимизация — пропустить проверку версий пакетов.
- `--skip-env-check` / `--require-env` — управление требованием наличия файла `./.env`.
- `--ensure-structure` / `--skip-structure-check` — включает/выключает предварительную проверку структуры проекта и автоматическую сборку инструментов `tools/quark-manager`.

Полезные внутренние функции, которые важно учесть при рефакторинге
- `dc()` — wrapper для `docker compose -f "$COMPOSE_FILE"`.
- `wait_for_health(service, timeout)` — ожидает здорового состояния контейнера; special-case для `verdaccio` (HTTP 200 на 127.0.0.1:4873 считается healthy). Если контейнер не имеет healthcheck, `running` считается OK.
- `check_ports()` — узнаёт, какие порты заняты; для `4873` делает дополнительную логику (если Verdaccio отвечает 200 — продолжает; если 404 — пробует убить процесс/остановить контейнер и перезапустить; в противном случае просит вмешательство).
- `check_project_structure()` — при включённом режиме пытается собрать `tools/quark-manager` и запустить `check-structure.js`.

Эти подробные описания должны помочь при переносе кода в более структурированную реализацию (например, на Python/Go/Node) или при разбиении скрипта на модули.

---
Если хочешь, следующим шагом могу прямо реализовать флаг `--skip-cache-warmup` (и сделать его поддерживаемым для `start` и `build`) — это будет минимальное изменение в `quark-manager.sh` и позволит выполнять быстрый `start` без прогрева Verdaccio. Напиши — и я внесу правку и протестирую.
